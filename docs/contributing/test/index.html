<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-contributing/test" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Testing | Athena</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://athena.qubitpi.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://athena.qubitpi.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://athena.qubitpi.org/docs/contributing/test"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Testing | Athena"><meta data-rh="true" name="description" content="[//]: # (Copyright 2024 Jiaqi Liu)"><meta data-rh="true" property="og:description" content="[//]: # (Copyright 2024 Jiaqi Liu)"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://athena.qubitpi.org/docs/contributing/test"><link data-rh="true" rel="alternate" href="https://athena.qubitpi.org/docs/contributing/test" hreflang="en"><link data-rh="true" rel="alternate" href="https://athena.qubitpi.org/docs/contributing/test" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Athena RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Athena Atom Feed"><link rel="stylesheet" href="/assets/css/styles.a4d38793.css">
<script src="/assets/js/runtime~main.a0aec4b3.js" defer="defer"></script>
<script src="/assets/js/main.f9b267a8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Athena Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Athena Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Athena</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://athena.qubitpi.org/apidocs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/QubitPi/athena" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Getting Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/system-config">System Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/monitoring-and-operations">Monitoring and Operations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/logging-guidelines">Logging Guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/kpi">Key Performance Indicators - Athena Web Service</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/contributor-guide">Contributor Guide</a><button aria-label="Collapse sidebar category &#x27;Contributor Guide&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contributing/development">Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contributing/jersey-di-using-hk2">Basic Dependency Injection using Jersey&#x27;s HK2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/contributing/test">Testing</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/client-apis">Client APIs</a><button aria-label="Expand sidebar category &#x27;Client APIs&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/filestore">File Stores</a><button aria-label="Expand sidebar category &#x27;File Stores&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/contributor-guide"><span itemprop="name">Contributor Guide</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Testing</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Testing</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="groovy-spock">Groovy Spock<a href="#groovy-spock" class="hash-link" aria-label="Direct link to Groovy Spock" title="Direct link to Groovy Spock">​</a></h2>
<p>We&#x27;re <em>big</em> believers in testing our code, both for correctness, as well as to ensure that changes don&#x27;t unintentionally
break existing contracts unintentionally. For example, we rely heavily on the <a href="http://spockframework.org/" target="_blank" rel="noopener noreferrer">Spock</a>
framework for our backend service tests, and see a lot of benefit from it&#x27;s conciseness, built-in
<a href="http://spockframework.org/spock/docs/1.1-rc-2/interaction_based_testing.html" target="_blank" rel="noopener noreferrer">mocking framework</a>, and the fact that it uses <a href="http://www.groovy-lang.org/" target="_blank" rel="noopener noreferrer">Groovy</a>.</p>
<p>We also strive for very high-quality code, with the belief that quality code is easier to maintain, easier to
understand, and has fewer bugs. To help keep the quality bar high. For instance we have an automated style checker
(<a href="http://checkstyle.sourceforge.net/" target="_blank" rel="noopener noreferrer">Checkstyle</a>) in our Maven-based projects with rules that <em>should</em> catch most of the common style issues.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="servlet-testing">Servlet Testing<a href="#servlet-testing" class="hash-link" aria-label="Direct link to Servlet Testing" title="Direct link to Servlet Testing">​</a></h2>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The design of athena-core tests, servlet tests in particular, draws extensively from
<a href="https://github.com/yahoo/fili/blob/master/fili-core/src/test/java/com/yahoo/bard/webservice/application/JerseyTestBinder.java" target="_blank" rel="noopener noreferrer">fili</a></p><p>One noticeable deviation is that since some of Fili&#x27;s classes have made it possible for themselves to be mutable,
which Athena doesn&#x27;t do, the stubbing is defined not on these classes, but on
<a href="/assets/files/ApplicationState-828f5f846b9db71876d1bc530d610505.java" target="_blank">ApplicationState</a>, which
is a modified adaption of Fili ApplicationState</p></div></div>
<p><a href="https://github.com/QubitPi/athena/tree/master/athena-core/src/main/java/io/github/qubitpi/athena/web/endpoints" target="_blank" rel="noopener noreferrer">Servlet-related testing</a>
is carried out using
<a href="https://qubitpi.github.io/jersey/test-framework.html" target="_blank" rel="noopener noreferrer">Jersey Test Framework</a>.</p>
<p><img decoding="async" loading="lazy" alt="Error loading class-diagram.png" src="/assets/images/class-diagram-a5c1c8daba1cd5ba117b1da00b3f716a.png" width="2762" height="2269" class="img_ev3q"></p>
<p>Each
<a href="https://github.com/QubitPi/athena/tree/master/athena-core/src/test/groovy/io/github/qubitpi/athena/web/endpoints" target="_blank" rel="noopener noreferrer"><code>***ServletSpec.groovy</code></a>
follows the following pattern to setup, run, and shutdown tests:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-initializing-applicationstate">1. Initializing ApplicationState<a href="#1-initializing-applicationstate" class="hash-link" aria-label="Direct link to 1. Initializing ApplicationState" title="Direct link to 1. Initializing ApplicationState">​</a></h3>
<p>Test specs initializes test data and mocking through
<a href="/assets/files/ApplicationState-828f5f846b9db71876d1bc530d610505.java" target="_blank">ApplicationState</a> in
<code>setup()</code></p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def setup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ApplicationState applicationState = new ApplicationState();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationState.metadataByFileId = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationState.queryFormatter = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationState.mutationFormatter = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>applicationState.metadataByFileId</code> initializes GraphQL DataFetcher data</li>
<li><code>queryFormatter</code> transforms a (file ID, metadata field list) pair to a native GraphQL query</li>
<li><code>mutationFormatter</code> transforms a (file ID, metadata object) pair to a native GraphQL query that persists a new
metadata to database (or just in-memory that usually suffices in testing scenarios)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-creating-test-harness">2. Creating Test Harness<a href="#2-creating-test-harness" class="hash-link" aria-label="Direct link to 2. Creating Test Harness" title="Direct link to 2. Creating Test Harness">​</a></h3>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def setup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jerseyTestBinder = new JerseyTestBinder(true, applicationState, ***Servlet.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Executing the statement above will start a <a href="https://javaee.github.io/grizzly/" target="_blank" rel="noopener noreferrer">Grizzly container</a>. After that all Athena
endpoints are ready to receive test requests.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When writing tests for
<a href="/assets/files/FileServlet-25093695fbb4452740c1342d9b0fe60b.java" target="_blank">FileServlet</a>, make sure
<code>MultiPartFeature.class</code> is also passed in as a resource class since the file uploading involves a separate Jersey
component enabled by it. For example:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jerseyTestBinder = new BookJerseyTestBinder(true, FileServlet.class, MultiPartFeature.class)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>The first boolean argument (<code>true</code>) is a flag to indicate whether or not, on executing the statement, servlet container
starts immediately. If we would like to defer the startup, change that to <code>false</code> and manually start the container later
by</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jerseyTestBinder.start()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Internally
<a href="/assets/files/JerseyTestBinder-c3c2c41aa7a1f4165e0572b16873646a.java" target="_blank">JerseyTestBinder</a> sets
<a href="/assets/files/TestBinderFactory-049f7a6d08889c1c179027cf2e2db458.java" target="_blank">TestBinderFactory</a> to
bind those data and behaviors into the actual test</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The <a href="/assets/files/JerseyTestBinder-c3c2c41aa7a1f4165e0572b16873646a.java" target="_blank">JerseyTestBinder</a>
creates separate container for each test. Setup method is named <code>setup()</code> and teardown method <code>cleanup()</code> by Groovy
Spock convention.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-running-tests">3. Running Tests<a href="#3-running-tests" class="hash-link" aria-label="Direct link to 3. Running Tests" title="Direct link to 3. Running Tests">​</a></h3>
<p>To send test request in order to test endpoints, use <code>JerseyTestBinder.makeRequest</code> method, which returns a native
javax rs ws request object:</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def &quot;File meta data can be accessed through GraphQL GET endpoint&quot;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    when: &quot;we get meta data via GraphQL GET&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String actual = jerseyTestBinder.makeRequest(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;/metadata/graphql&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [query: URLEncoder.encode(&quot;&quot;&quot;{metaData(fileId:&quot;$FILE_ID&quot;){fileName\nfileType}}&quot;&quot;&quot;, &quot;UTF-8&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ).get(String.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    then: &quot;the response contains all requested metadata info without error&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new JsonSlurper().parseText(actual) == new JsonSlurper().parseText(expectedMultiFieldMetadataResponse())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-tearing-down-tests">4. Tearing Down Tests<a href="#4-tearing-down-tests" class="hash-link" aria-label="Direct link to 4. Tearing Down Tests" title="Direct link to 4. Tearing Down Tests">​</a></h3>
<p>The teardown shuts down test container as well as cleaning up all ApplicationStates we defined in
<a href="#1-initializing-applicationstate">step 1</a></p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def cleanup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Release the test web container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jerseyTestBinder.tearDown()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-custom-resources-to-resourceconfig">Adding Custom Resources to ResourceConfig<a href="#adding-custom-resources-to-resourceconfig" class="hash-link" aria-label="Direct link to Adding Custom Resources to ResourceConfig" title="Direct link to Adding Custom Resources to ResourceConfig">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.IllegalStateException: org.glassfish.jersey.server.model.ModelValidationException: Validation of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">application resource model has failed during application initialization.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[FATAL] No injection source found for a parameter of type public javax.ws.rs.core.Response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: org.glassfish.jersey.server.model.ModelValidationException: Validation of the application resource model has</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">failed during application initialization.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Athena uses ResourceConfig type for configuration. We need to register the <code>MultiPartFeature</code>. Instead of using
<a href="/assets/files/ResourceConfig-98682af6d003898aff42b69a96c07288.java" target="_blank">Athena ResourceConfig</a>,
servlet test spec configures with the native
<a href="https://github.com/eclipse-ee4j/jersey/blob/master/core-server/src/main/java/org/glassfish/jersey/server/ResourceConfig.java" target="_blank" rel="noopener noreferrer">Jersey ResourceConfig</a>.
The reason is so that we could bind certain resource classes that we only need in a test spec to enhance test
efficiency.</p>
<p>Athena ResourceConfig registers MultiPartFeature by default, whereas Jersey ResourceConfig does not. We could register
this resource as an extra resource class using</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jerseyTestBinder = new JerseyTestBinder(true, applicationState, FileServlet.class, MultiPartFeature.class)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that along with the <code>FileServlet</code> resource that&#x27;s going to be registered and tested, <code>MultiPartFeature</code> will also
got registered by Jersey ResourceConfig.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="database">Database<a href="#database" class="hash-link" aria-label="Direct link to Database" title="Direct link to Database">​</a></h2>
<p>Database-related tests contain 2 parts</p>
<ol>
<li>
<p>Groovy Spock unit tests on</p>
<ul>
<li><a href="/assets/files/SQLQueryDataFetcherSpec-76b61631da0d5cdf3b9dcded13037a97.groovy" target="_blank">Injected Query DataFetcher</a></li>
<li><a href="/assets/files/SQLMutationDataFetcherSpec-db7cec5288eb0b3c34b6e9aaf8b2613a.groovy" target="_blank">Injected Mutation DataFetcher</a></li>
</ul>
</li>
<li>
<p>Live DB tests on endpoints</p>
<ul>
<li>In <a href="/assets/files/FileServletSpec-9d70cdac1029d61fdb41feb8902c1397.groovy" target="_blank">file servlet endpoint test</a>
and
<a href="/assets/files/MetaServletSpec-45e5b636146638e1be210e41f86e770a.groovy" target="_blank">meta data servlet endpoint test</a>,
<a href="/assets/files/SQLDBResourceManager-5564cdbf154d3a2aefb3f7186860dadd.groovy" target="_blank">Flyway migration</a>
injects real data into a Derby in-meomroy SQL DB</li>
<li>The Derby data is injected via a shared <a href="#reference---apache-commons-dbcp2">DBCP DataSource</a> declared in
<a href="/assets/files/BooksBinderFactory-6a16dbfddda4c662daee959ddeb1971d.java" target="_blank">application BinderFactory</a></li>
<li>The application resource is set alive through
<a href="/assets/files/BookJerseyTestBinder-ee91e2eb0ec0ba2563f4f62f68cad2de.java" target="_blank">JerseyTestBinder</a></li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reference---apache-commons-dbcp2">Reference - Apache Commons DBCP2<a href="#reference---apache-commons-dbcp2" class="hash-link" aria-label="Direct link to Reference - Apache Commons DBCP2" title="Direct link to Reference - Apache Commons DBCP2">​</a></h3>
<p>For testing Book example application, we use Derby&#x27;s in-memory database facility, which resides completely in main
memory, not in the file system.</p>
<p>In addition, we use <a href="https://commons.apache.org/proper/commons-dbcp/" target="_blank" rel="noopener noreferrer">Apache DBCP 2</a> to provide
<a href="https://gitbox.apache.org/repos/asf?p=commons-dbcp.git;a=blob_plain;f=doc/BasicDataSourceExample.java;hb=HEAD" target="_blank" rel="noopener noreferrer">DataSource</a>
pointing at the in-memory Derby instance.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="derby">Derby<a href="#derby" class="hash-link" aria-label="Direct link to Derby" title="Direct link to Derby">​</a></h3>
<p>Derby was meant to be used only in tests and, hence, must be imported in test scope only</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/QubitPi/athena/tree/master/docs/docs/contributing/test.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/contributing/jersey-di-using-hk2"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Basic Dependency Injection using Jersey&#x27;s HK2</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/faq"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">FAQ</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#groovy-spock" class="table-of-contents__link toc-highlight">Groovy Spock</a></li><li><a href="#servlet-testing" class="table-of-contents__link toc-highlight">Servlet Testing</a><ul><li><a href="#1-initializing-applicationstate" class="table-of-contents__link toc-highlight">1. Initializing ApplicationState</a></li><li><a href="#2-creating-test-harness" class="table-of-contents__link toc-highlight">2. Creating Test Harness</a></li><li><a href="#3-running-tests" class="table-of-contents__link toc-highlight">3. Running Tests</a></li><li><a href="#4-tearing-down-tests" class="table-of-contents__link toc-highlight">4. Tearing Down Tests</a></li></ul></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a><ul><li><a href="#adding-custom-resources-to-resourceconfig" class="table-of-contents__link toc-highlight">Adding Custom Resources to ResourceConfig</a></li></ul></li><li><a href="#database" class="table-of-contents__link toc-highlight">Database</a><ul><li><a href="#reference---apache-commons-dbcp2" class="table-of-contents__link toc-highlight">Reference - Apache Commons DBCP2</a></li><li><a href="#derby" class="table-of-contents__link toc-highlight">Derby</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/QubitPi/athena/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.com/widget?id=1001320502960324658&amp;theme=dark" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/QubitPi/athena" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Jiaqi Liu. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>